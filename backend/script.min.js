/*!
 * backend/script.js
 * 
 * @author Leonardo Laureti <https://loltgt.ga>
 * @version staging
 * @license MIT License
 */
const bepath="/backend",beroutes={"":{"":main,login:signin,logout:signout},store:{"":view_list,add:view_edit,edit:view_edit},domains:{"":view_list,add:view_edit,edit:view_edit},users:{"":view_list,add:view_edit,edit:view_edit},test:{"":api_test}};let benav;const apipath="/api";function main(){const e=document.getElementById("main");nav(e.querySelector(".nav")),e.removeAttribute("hidden")}function view_list(e,t,n){const o=document.querySelector(".view-list"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","view-list"),r.cloned=!0,document.body.insertBefore(r,o);const i=document.getElementById("view-list"),s=i.querySelector(".nav.placeholder"),a=i.querySelector("h2");nav(s),a.innerText=e+" list",a.className="";const c=api_request("get","/"+e),l=i.querySelector("table"),u=l.querySelector("thead"),d=l.querySelector("tbody");function m(e){return e.preventDefault(),(e.target.parentElement.classList.contains("action-edit")||"TD"==e.target.tagName)&&route(this.dataset.href),!1}function p(e){return e.preventDefault(),window.confirm("Are you sure to delete this item?")&&route(this.href),!1}function f(e){console.error("view_list()","error()",e)}c.then(function(e){try{const t=JSON.parse(e.response);if(!t.status)return f();t.data&&function(e){var t=0;let n="#";const o=d.firstElementChild;for(const r in e){const i=o.cloneNode(!0),s=i.firstElementChild,a=i.querySelector("td.action-edit > a"),c=i.querySelector("td.action-delete > a");for(const o in e[r]){const a=e[r][o];if(-1!=o.indexOf("_id")&&(n=a.toString()),0===t){const e=document.createElement("th");e.innerText=o,u.firstElementChild.insertBefore(e,u.firstElementChild.lastElementChild)}const c=document.createElement("td");c.innerText=a?a.toString():"",i.insertBefore(c,s)}a.href+=n,c.href+=n,c.onclick=p,i.setAttribute("data-href",a.href),i.onclick=m,d.prepend(i),t++}o.remove(),l.classList.remove("placeholder")}(t.data)}catch(e){console.error("view_list()","load()",e),f()}}).catch(f),i.removeAttribute("hidden")}function view_edit(e,t,n){const o=document.querySelector(".view-edit"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","view-edit"),r.cloned=!0,document.body.insertBefore(r,o);const i=document.getElementById("view-edit"),s=i.querySelector(".nav.placeholder"),a=i.querySelector("h2");nav(s),a.innerText=e+" edit",a.className="";const c=api_request("put","/"+e,"user_id="+n),l=i.querySelector("form"),u=l.firstElementChild;function d(e){console.error("view_edit()","error()",e)}c.then(function(e){try{const t=JSON.parse(e.response);if(!t.status)return d();t.data&&function(e){const t=document.createElement("fieldset");for(const n in e)for(const o in e[n]){const r=e[n][o],i=document.createElement("div"),s=document.createElement("label"),a=document.createElement("input");s.innerText=o,a.setAttribute("type","text"),a.value=r?r.toString():"",i.append(s),i.append(a),t.append(i),l.insertBefore(t,u)}l.classList.remove("placeholder")}(t.data)}catch(e){console.error("view_edit()","load()",e),d()}}).catch(d),i.removeAttribute("hidden")}function signin(){const e=document.getElementById("signin"),t=document.getElementById("sign_login"),n=t.querySelector(".placeholder").cloneNode(),o=3;let r=0,i=null;function s(n){t.reset();try{const c=JSON.parse(n.response);if(c.status&&c.data){t.removeAttribute("disabled"),t.removeAttribute("data-loading"),e.setAttribute("hidden","");var i="path="+bepath+"; ",s="expires="+new Date((new Date).getTime()+864e5).toGMTString()+"; ";return console.log("signin()","next()","urls-sign=1; "+i+s+"samesite=strict"),document.cookie="urls-sign=1; "+i+s+"samesite=strict",route(bepath+"/")}throw r++<o&&t.removeAttribute("disabled"),"Wrong credentials."}catch(e){t.removeAttribute("data-loading"),a(n,e)}}function a(e,n){t.reset(),e&&!n&&e.status&&(n="An error occurred."),(i=document.createElement("div")).className="error",i.innerText=n,t.querySelector(".placeholder").replaceWith(i),console.error("signin()","error()",n)}document.cookie="urls-sign=; expires="+new Date(0).toGMTString()+", samesite=strict",t.addEventListener("submit",function(e){e.preventDefault(),t.setAttribute("disabled",""),t.setAttribute("data-loading",""),i&&i.replaceWith(n);let o=[];for(const e of this.elements)"FIELDSET"==e.tagName||"BUTTON"==e.tagName||e.type&&"button"===e.type||o.push(e.name+"="+e.value);if(!o.length)return t.removeAttribute("disabled"),t.removeAttribute("data-loading"),a(null,"Please enter your credentials.");api_request("post","/",o=o.join("&")).then(s).catch(a)}),e.removeAttribute("hidden")}function signout(){return route(bepath+"/?login")}function api_request(e,t,n){const o=new XMLHttpRequest;let r=apipath+t;return"/"!=r.substr(-1)&&(r+="/"),n&&"get"===e&&(r+="?"+n,n=null),o.open(e,r),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(n),new Promise(function(e,t){o.onload=function(){e(o)},o.onerror=function(){t(o)}})}
/*!
 * backend/api_test.js
 * 
 * @author Leonardo Laureti <https://loltgt.ga>
 * @version staging
 * @license MIT License
 */
function api_test(){const e=document.getElementById("api-test"),t=e.querySelector(".nav"),n=document.getElementById("api_request"),o=document.getElementById("api_response"),r=api_request("get","/",""),i=n.querySelector('[name="endpoint"]'),s=n.querySelector('[name="method"]'),a=n.querySelector('[name="route"]'),c=n.querySelector('[name="body"]'),l=o.querySelector('[name="response-status"]'),u=o.querySelector('[name="response-body"]'),d=o.querySelector('[name="response-headers"]');let m;function p(e){console.log("api_test()","response()",e),o.removeAttribute("data-loading"),l.value=e.status,u.value=e.response,d.value=e.getAllResponseHeaders()}function f(t){console.log("api_test()","load()",t);try{e.removeAttribute("hidden");const n=JSON.parse(t.response);if(!n.status)return e.setAttribute("hidden",""),route(bepath+"/?login");m=n.data;for(const e in n.data){let t;(t=document.createElement("option")).value=e,t.innerText=e,i.appendChild(t)}h(),v()}catch(e){console.error("api_test()","load()",e)}}function h(){try{if(!m)throw 0;const e=i.value;s.innerHTML="";for(const t in m[e]){let e;(e=document.createElement("option")).value=t.toLowerCase(),e.innerText=t,s.appendChild(e)}v()}catch(e){console.error("api_test()","endpointChange()",e)}}function v(){try{if(!m)throw 0;const e=i.value,t=s.value.toUpperCase();a.value=JSON.stringify(m[e][t])}catch(e){console.error("api_test()","methodChange()",e)}}nav(t),n.addEventListener("submit",function(e){e.preventDefault();const t=api_request(s.value,i.value,c.value);o.setAttribute("data-loading",""),t.then(p).catch(p)}),n.addEventListener("reset",function(e){e.preventDefault(),c.value=""}),i.addEventListener("change",h),s.addEventListener("change",v),r.then(f).catch(f)}function nav(e){const t=document.getElementById("nav").cloneNode(!0),n=t.querySelectorAll("a");function o(e){return e.preventDefault(),route(this.href),!1}for(const e of n)e.href=bepath+"/"+e.getAttribute("href"),e.onclick=o;if(t.removeAttribute("id"),t.removeAttribute("hidden"),benav=t,e){benav.cloneNode(!0);e.replaceWith(benav)}return benav}function route(e,t){const n=document.querySelectorAll("main"),o=!!e;if(e=e||window.location.href,t=t||document.title,-1===e.indexOf(bepath))throw"Wrong backend path";const r=e.replace(window.location.protocol+"//"+window.location.host,""),i=r.split("?"),s=i[0].split("/")[2],a=i[1]?i[1].split("="):"",c=a[0]?a[0]:"",l=a[1]?a[1]:"";console.info("route()",{path:i,uri:s,qs:a,key:c,value:l});for(const e of n)e.cloned&&e.remove(),e.setAttribute("hidden","");if(void 0!=s&&s in beroutes==!1)throw"Wrong URI Route";if(void 0!=c&&c in beroutes[s]==!1)throw"Wrong QueryString Route";if("function"!=typeof beroutes[s][c])throw"Callable Function";o&&history.pushState("",t,r),beroutes[s][c].call(this,s,c,l)}function init(){var e="path="+bepath+"; ",t="expires="+new Date((new Date).getTime()+6e4).toGMTString()+"; ";if(document.cookie="urls-test=1; "+e+t+"samesite=strict",-1===document.cookie.indexOf("urls-test"))return"";-1!=document.cookie.indexOf("urls-sign")?(nav(),route()):signin()}init();