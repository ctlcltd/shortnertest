/*!
 * backend/script.js
 * 
 * @author Leonardo Laureti <https://loltgt.ga>
 * @version staging
 * @license MIT License
 */
const bepath="/backend",beroutes={"":{"":main,login:signin,logout:signout},store:{"":view_list,add:view_edit,edit:view_edit},domains:{"":view_list,add:view_edit,edit:view_edit},users:{"":view_list,add:view_edit,edit:view_edit},test:{"":api_test}};let benav;const apipath="/api";function main(){const e=document.getElementById("main");nav(e.querySelector(".nav")),e.removeAttribute("hidden")}function view_list(e,t,n){const o=document.querySelector(".view-list"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","view-list"),r.cloned=!0,document.body.insertBefore(r,o);const i=document.getElementById("view-list"),a=i.querySelector(".nav.placeholder"),s=i.querySelector("h2");nav(a),s.innerText=e+" list",s.className="";const c=api_request("get","/"+e),l=i.querySelector("table"),u=l.querySelector("thead"),d=l.querySelector("tbody");function m(e){return e.preventDefault(),(e.target.parentElement.classList.contains("action-edit")||"TD"==e.target.tagName)&&route(this.dataset.href),!1}function p(e){return e.preventDefault(),window.confirm("Are you sure to delete this item?")&&route(this.href),!1}function h(e,t){console.error("view_list()","error()",e||"",t||"")}c.then(function(e){try{const t=JSON.parse(e.response);if(!t.status)return h(t.data);t.data&&function(e){var t=0;let n;const o=d.firstElementChild;for(const r in e){const i=o.cloneNode(!0),a=i.firstElementChild,s=i.querySelector("td.action-edit > a"),c=i.querySelector("td.action-delete > a");for(const o in e[r]){const s=e[r][o];if(n||-1==o.indexOf("_id")||(n="&"+o+"="+s.toString()),0===t){const e=document.createElement("th");e.innerText=o,u.firstElementChild.insertBefore(e,u.firstElementChild.lastElementChild)}const c=document.createElement("td");c.innerText=s?s.toString():"",i.insertBefore(c,a)}s.href+=n,c.href+=n,c.onclick=p,i.setAttribute("data-href",s.href),i.onclick=m,d.prepend(i),t++}o.remove(),l.classList.remove("placeholder")}(t.data)}catch(e){console.error("view_list()","load()",e),h(null,e)}}).catch(h),i.removeAttribute("hidden")}function view_edit(e,t,n){const o=document.querySelector(".view-edit"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","view-edit"),r.cloned=!0,document.body.insertBefore(r,o);const i=document.getElementById("view-edit"),a=i.querySelector(".nav.placeholder"),s=i.querySelector("h2");nav(a),s.innerText=e+" edit",s.className="";const c=api_request("put","/"+e,n),l=i.querySelector("form"),u=l.firstElementChild;function d(e,t){console.error("view_edit()","error()",e||"",t||"")}c.then(function(e){try{const t=JSON.parse(e.response);if(!t.status)return d(t.data);t.data&&function(e){const t=document.createElement("fieldset");for(const n in e){const o=e[n],r=document.createElement("div"),i=document.createElement("label"),a=document.createElement("input");i.innerText=n,a.setAttribute("type","text"),a.value=o?o.toString():"",r.append(i),r.append(a),t.append(r),l.insertBefore(t,u)}l.classList.remove("placeholder")}(t.data)}catch(e){console.error("view_edit()","load()",e),d(!1,e)}}).catch(d),i.removeAttribute("hidden")}function signin(){const e=document.getElementById("signin"),t=document.getElementById("sign_login"),n=t.querySelector(".placeholder").cloneNode(),o=3;let r=0,i=null;function a(n){t.reset();try{const c=JSON.parse(n.response);if(c.status&&c.data){t.removeAttribute("disabled"),t.removeAttribute("data-loading"),e.setAttribute("hidden","");var i="path="+bepath+"; ",a="expires="+new Date((new Date).getTime()+864e5).toGMTString()+"; ";return console.log("signin()","next()","urls-sign=1; "+i+a+"samesite=strict"),document.cookie="urls-sign=1; "+i+a+"samesite=strict",route(bepath+"/")}throw r++<o&&t.removeAttribute("disabled"),"Wrong credentials."}catch(e){t.removeAttribute("data-loading"),s(n,e)}}function s(e,n){t.reset(),e&&!n&&e.status&&(n="An error occurred."),(i=document.createElement("div")).className="error",i.innerText=n,t.querySelector(".placeholder").replaceWith(i),console.error("signin()","error()",n)}document.cookie="urls-sign=; expires="+new Date(0).toGMTString()+", samesite=strict",t.addEventListener("submit",function(e){e.preventDefault(),t.setAttribute("disabled",""),t.setAttribute("data-loading",""),i&&i.replaceWith(n);let o=[];for(const e of this.elements)"FIELDSET"==e.tagName||"BUTTON"==e.tagName||e.type&&"button"===e.type||o.push(e.name+"="+e.value);if(!o.length)return t.removeAttribute("disabled"),t.removeAttribute("data-loading"),s(null,"Please enter your credentials.");api_request("post","/",o=o.join("&")).then(a).catch(s)}),e.removeAttribute("hidden")}function signout(){return route(bepath+"/?login")}function api_request(e,t,n){const o=new XMLHttpRequest;let r=apipath+t;return"/"!=r.substr(-1)&&(r+="/"),n&&"get"===e&&(r+="?"+n,n=null),o.open(e,r),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(n),new Promise(function(e,t){o.onload=function(){e(o)},o.onerror=function(){t(o)}})}
/*!
 * backend/api_test.js
 * 
 * @author Leonardo Laureti <https://loltgt.ga>
 * @version staging
 * @license MIT License
 */
function api_test(){const e=document.getElementById("api-test"),t=e.querySelector(".nav"),n=document.getElementById("api_request"),o=document.getElementById("api_response"),r=api_request("get","/",""),i=n.querySelector('[name="endpoint"]'),a=n.querySelector('[name="method"]'),s=n.querySelector('[name="route"]'),c=n.querySelector('[name="body"]'),l=o.querySelector('[name="response-status"]'),u=o.querySelector('[name="response-body"]'),d=o.querySelector('[name="response-headers"]');let m;function p(e){console.log("api_test()","response()",e),o.removeAttribute("data-loading"),l.value=e.status,u.value=e.response,d.value=e.getAllResponseHeaders()}function h(t){console.log("api_test()","load()",t);try{e.removeAttribute("hidden");const n=JSON.parse(t.response);if(!n.status)return e.setAttribute("hidden",""),route(bepath+"/?login");m=n.data;for(const e in n.data){let t;(t=document.createElement("option")).value=e,t.innerText=e,i.appendChild(t)}f(),v()}catch(e){console.error("api_test()","load()",e)}}function f(){try{if(!m)throw 0;const e=i.value;a.innerHTML="";for(const t in m[e]){let e;(e=document.createElement("option")).value=t.toLowerCase(),e.innerText=t,a.appendChild(e)}v()}catch(e){console.error("api_test()","endpointChange()",e)}}function v(){try{if(!m)throw 0;const e=i.value,t=a.value.toUpperCase();s.value=JSON.stringify(m[e][t])}catch(e){console.error("api_test()","methodChange()",e)}}nav(t),n.addEventListener("submit",function(e){e.preventDefault();const t=api_request(a.value,i.value,c.value);o.setAttribute("data-loading",""),t.then(p).catch(p)}),n.addEventListener("reset",function(e){e.preventDefault(),c.value=""}),i.addEventListener("change",f),a.addEventListener("change",v),r.then(h).catch(h)}function nav(e){const t=document.getElementById("nav").cloneNode(!0),n=t.querySelectorAll("a");function o(e){return e.preventDefault(),route(this.href),!1}for(const e of n)e.href=bepath+"/"+e.getAttribute("href"),e.onclick=o;if(t.removeAttribute("id"),t.removeAttribute("hidden"),benav=t,e){benav.cloneNode(!0);e.replaceWith(benav)}return benav}function route(e,t){const n=document.querySelectorAll("main"),o=!!e;if(e=e||window.location.href,t=t||document.title,-1===e.indexOf(bepath))throw"Wrong backend path";const r=e.replace(window.location.protocol+"//"+window.location.host,""),i=r.split("?"),a=i[0].split("/")[2],s=i[1]?i[1].split("&"):"",c=s[0]?s[0]:"",l=s[1]?s[1]:"";console.info("route()",{path:i,uri:a,qs:s,key:c,value:l});for(const e of n)e.cloned&&e.remove(),e.setAttribute("hidden","");if(void 0!=a&&a in beroutes==!1)throw"Wrong URI Route";if(void 0!=c&&c in beroutes[a]==!1)throw"Wrong QueryString Route";if("function"!=typeof beroutes[a][c])throw"Callable Function";o&&history.pushState("",t,r),beroutes[a][c].call(this,a,c,l)}function init(){var e="path="+bepath+"; ",t="expires="+new Date((new Date).getTime()+6e4).toGMTString()+"; ";if(document.cookie="urls-test=1; "+e+t+"samesite=strict",-1===document.cookie.indexOf("urls-test"))return"";-1!=document.cookie.indexOf("urls-sign")?(nav(),route()):signin()}init();